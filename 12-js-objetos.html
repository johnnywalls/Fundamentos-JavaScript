<!DOCTYPE html>
<html lang="es">
<head>
  <title>JS: Objetos</title>
  <meta charset="UTF-8">
</head>
<body>
  <h1>JS: Objetos</h1>
  <script>
    // Podemos crear un objeto utilizando el operador "new"
    var album = new Object();

    // Podemos asignar directamente valores a propiedades
    album.titulo = "Revolver";
    album.artista = "The Beatles";
    album.año = 1966;
    console.log( album );

    /* También podemos acceder a propiedades utilizando sus
       nombres como si fuesen índices de un arreglo */
    album["sello"] = "EMI";
    console.log( album["titulo"] );
    var propiedad = "artista";
    console.log( album[ propiedad ] );

    /* Podemos iterar sobre las propiedades de un objeto, si
       nuestro navegador ha implementado al menos el estándar
       ECMAScript 5 (ver tabla en referencias) */
    function mostrar_propiedades( objeto ){
      var resultado = "";
      for (var propiedad in objeto) {
        if ( objeto.hasOwnProperty(propiedad) ) {
            resultado += propiedad + " = " + objeto[propiedad] + "\n";
        }
      }
      return resultado;
    }

    console.log( mostrar_propiedades( album ) );
    
    // También podemos crear un objeto "inicializando" propiedades
    var album2 = {
      titulo: 'Dark side of the moon',
      artista: 'Pink Floyd'
    };
    console.log( album2 );
    /* Nótese que cada propiedad puede almacenar cualquier tipo de datos
       (números, cadenas, arreglos, funciones, otros objetos) */
    album2 = {
      titulo: 'Dark side of the moon',
      artista: {
        nombre: 'Pink Floyd',
        año_formacion: 1965
      },
      año: 1973,
      singles: [ { lado_a:'Money', lado_b: 'Any colour you like' }, 
                 { lado_a: 'Time', lado_b: 'Us and them'} ]
    };
    console.log( album2 );

    /* Podemos especificar una función "constructor", usualmente
       cuando queremos aplicar algunas reglas, validaciones, valores
       predeterminados, etc */
    function Artista( nombre, año_formacion ) {
      if ( typeof nombre === 'string' ) {
        this.nombre = nombre;
      }
      if ( typeof año_formacion === 'number' ) {
        this.año_formacion = año_formacion;
      }
    }

    function Album( titulo, artista, año ) {
      if ( typeof titulo == 'string' ) {
        this.titulo = titulo;
      }

      if ( typeof artista === 'Artista' ) {
        this.artista = artista;
      }
      else if ( typeof artista === 'string' ) {
        this.artista = new Artista( artista );
      }

      if ( typeof año === 'number' ) {
        this.año = año;
      }
      if ( año === undefined ) {
        this.año = (new Date()).getFullYear();
      }
    }

    var abbey = new Album( 'Abbey Road', 'The Beatles', 1969 );
    var blur = new Album( 'The Magic Whip', 'Blur' );
    console.log( blur );

    /* También podemos crear un objeto a partir de la definición
       de otro, sin definir necesariamente un constructor */
    var Animal = {
      tipo: 'Invertebrados'
    };
    var pulpo = Object.create( Animal );
    console.log( pulpo );
    var sapo = Object.create( Animal );
    sapo.tipo = 'Anfibios';
    console.log( sapo );

    /* La "herencia" en JS se basa en el uso de "prototipos" */
    // Constructor
    var Persona = function( nombre ) {
      this.nombre = nombre;
    };

    // Agregamos métodos al "prototipo" de Persona
    Persona.prototype.caminar = function(){
      console.log("¡Voy caminando!");
    };

    Persona.prototype.saludar = function() {
      console.log("Hola, me llamo " + this.nombre);
    };

    // Constructor de "subclase"
    function Estudiante(nombre, carrera) {
      // Invocar al constructor 'padre'
      Persona.call(this, nombre);

      // Inicializar propiedades específicas
      this.carrera = carrera;
    };

    /* Aquí especificamos la "herencia": El prototipo de Estudiante es 
       un objeto que "hereda" del prototipo de Persona */
    Estudiante.prototype = Object.create(Persona.prototype);

    /* Configurar el constructor apropiado para la subclase (no
       queremos usar directamente el constructor de 'Persona') */
    Estudiante.prototype.constructor = Estudiante;

    // Personalizar el método "saludar"
    Estudiante.prototype.saludar = function(){
      console.log("Hola, me llamo " + this.nombre + ". Estudio "
                  + this.carrera + ".");
    };

    // Agregar un método propio
    Estudiante.prototype.estudiar = function(){
      console.log("No puedo hablar, ¡hay finales mañana!");
    };

    var estudiante1 = new Estudiante("Marta", "Filosofía");
    estudiante1.saludar();
    estudiante1.caminar();
    estudiante1.estudiar();

    // Verificamos que 'instanceof' funciona correctamente
    console.log(estudiante1 instanceof Persona);  // true
    console.log(estudiante1 instanceof Estudiante); // true

    /* Podemos también definir métodos tipo 'get' y 'set' explícitamente
       para propiedades de los objetos */
    var pp = Persona.prototype;
    /* Definimos una propiedad llamada "fecha_nacimiento", que internamente
       almacenaremos en una variable "privada" al objeto llamada _fecha */
    Object.defineProperty( pp, 'fecha_nacimiento', {
      get: function(){
             return this._fecha.toLocaleString('es-ES');
           },
      set: function( valor ) {
             if ( typeof valor === 'string' || typeof valor === 'number' ) {
              this._fecha = new Date( valor );
             }
             else if ( typeof valor === 'object' && valor instanceof Date ) {
              this._fecha = valor;
             }
             else {
              this._fecha = undefined;
             }
           }
    });
    var estudiante2 = new Estudiante("Viviana", "Derecho");
    estudiante2.fecha_nacimiento = '1990-04-02T13:50:00';
    console.log( estudiante2 );
    console.log( estudiante2.fecha_nacimiento );

    estudiante2.fecha_nacimiento = new Date( '1991-04-02T13:50:00' );
    console.log( estudiante2.fecha_nacimiento );

    /* Nótese que podemos acceder a la variable "privada". Nombrarla
       comenzando con un "guión bajo" es una convención */
    console.log( estudiante2._fecha );
  </script>
</body>
</html>